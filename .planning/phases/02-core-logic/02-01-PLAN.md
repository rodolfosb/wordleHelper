---
phase: 02-core-logic
plan: 01
type: execute
depends_on: []
files_modified: [src/logic/constraints.ts, src/logic/filter.ts]
---

<objective>
Implement the constraint engine that filters words based on green/yellow/gray feedback.

Purpose: Enable word suggestions by eliminating words that violate known constraints from previous guesses.
Output: Two logic modules - constraint building and word filtering - that form the core engine.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# From Phase 1 Summary (01-01-SUMMARY.md):
**Tech stack available:** Vite, TypeScript
**Established patterns:** Types in src/types/index.ts, Data modules in src/data/
**Key files:**
@src/types/index.ts
@src/data/words.ts

**Constraining decisions:**
- Phase 1: Vanilla TypeScript (no React/Vue)
- Phase 1: Word list as const array with WORD_LIST and WORD_SET exports

**Key types already defined:**
- `LetterStatus`: 'green' | 'yellow' | 'gray'
- `LetterFeedback`: { letter, position, status }
- `GuessFeedback`: Tuple of 5 LetterFeedback
- `Constraints`: { exactPositions, requiredLetters, excludedLetters }
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create constraint builder from guess feedback</name>
  <files>src/logic/constraints.ts</files>
  <action>
Create a constraints module with two functions:

1. `createEmptyConstraints(): Constraints` - Factory for empty constraints object:
   - exactPositions: new Map()
   - requiredLetters: new Map()
   - excludedLetters: new Set()

2. `addGuessToConstraints(constraints: Constraints, guess: GuessFeedback): Constraints` - Process a guess and update constraints:
   - For GREEN letters: Add to exactPositions (position -> letter)
   - For YELLOW letters: Add letter to requiredLetters with this position excluded
   - For GRAY letters: Add to excludedLetters

**Important edge case:** A letter can be both YELLOW/GREEN and GRAY in the same guess (e.g., word "APPLE" guessed against "ALLOT" - first L is yellow, second L is gray). Only add to excludedLetters if the letter has NO green or yellow instances in the guess. Handle this by first collecting all greens/yellows, then only adding grays that aren't in that set.

Return a new Constraints object (immutable pattern) rather than mutating.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Module exports createEmptyConstraints and addGuessToConstraints, handles duplicate letter edge case, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create word filter using constraints</name>
  <files>src/logic/filter.ts</files>
  <action>
Create a filter module with:

`filterWords(words: string[], constraints: Constraints): string[]` - Filter word list against constraints:

1. Check exactPositions: If word[position] !== required letter, reject
2. Check requiredLetters:
   - Letter must appear somewhere in word
   - Letter must NOT be at any excluded position for that letter
3. Check excludedLetters: If word contains any excluded letter, reject

**Important edge case for excludedLetters:** If a letter is in requiredLetters (from yellow), it should NOT be excluded even if it's also in excludedLetters. The requiredLetters takes precedence (this handles the duplicate letter scenario from Task 1).

Use early returns for efficiency - check cheapest constraints first (exactPositions, then excludedLetters, then requiredLetters).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manual verification in main.ts:
- Import WORD_LIST, filterWords, createEmptyConstraints, addGuessToConstraints
- Create test: guess "CRANE" against target "APPLE" = gray C, gray R, yellow A, gray N, yellow E
- Build constraints, filter WORD_LIST, log count (should be significantly reduced)
  </verify>
  <done>filterWords correctly eliminates words violating constraints, handles precedence of requiredLetters over excludedLetters, ~90%+ reduction when filtering with typical guess constraints</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run dev` starts without errors
- [ ] Manual test in main.ts shows significant word reduction (from 2399 to <500 with one guess)
- [ ] Edge case handled: word with duplicate letters (e.g., "APPLE") correctly filtered
</verification>

<success_criteria>

- Both constraint and filter modules compile cleanly
- filterWords reduces word list significantly with real constraints
- Duplicate letter edge case handled correctly
- No TypeScript errors
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-logic/02-01-SUMMARY.md`
</output>
