---
phase: 04-user-interface
plan: FIX2
type: fix
---

<objective>
Fix 2 UAT issues from Phase 4 re-verification testing.

Source: 04-ISSUES.md
Priority: 1 major, 1 minor

These issues refine the real-time filtering UX to match user expectations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/04-user-interface/04-ISSUES.md

**Current implementation:**
@src/ui/GuessGrid.ts
@src/main.ts
@src/logic/filter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter on every keystroke (UAT-006)</name>
  <files>src/logic/filter.ts, src/main.ts, src/ui/GuessGrid.ts</files>
  <action>
    **Implement partial word filtering:**

    1. Add new function `filterByPrefix(words: string[], prefix: string): string[]` in filter.ts:
       - Takes a partial word (e.g., "cra") and returns words that start with it
       - Simple implementation: `words.filter(w => w.startsWith(prefix))`

    2. Add method `getCurrentPartialWord(): string` to GuessGrid:
       - Returns letters typed in current row (may be 0-4 letters)
       - Returns empty string if row is complete (5 letters)

    3. Modify `updateSuggestions()` in main.ts:
       - First apply full constraint filtering from complete rows (existing behavior)
       - Then, if current row has partial input (1-4 letters):
         - Get partial word via guessGrid.getCurrentPartialWord()
         - Apply prefix filter to the already-filtered words
       - This combines both constraint filtering AND partial prefix filtering

    **Logic flow:**
    ```
    allFeedback = complete rows only (no change)
    constraints = build from allFeedback (no change)
    filteredWords = filterWords(WORD_LIST, constraints)

    // NEW: Apply partial word prefix filter
    partialWord = guessGrid.getCurrentPartialWord()
    if (partialWord.length > 0) {
      filteredWords = filterByPrefix(filteredWords, partialWord)
    }

    rankedWords = rankWords(filteredWords, filteredWords)
    suggestions.update(rankedWords, filteredWords.length)
    ```
  </action>
  <verify>
    - Type "C" - word list narrows to words starting with C
    - Type "CR" - narrows further to words starting with CR
    - Type "CRA" - shows words starting with CRA
    - Complete "CRANE" - filters based on full constraints as before
    - Backspace to "CRAN" - reverts to prefix filtering for "cran"
  </verify>
  <done>Word list updates on every keystroke, filtering by prefix for partial words</done>
</task>

<task type="auto">
  <name>Task 2: Auto-recover focus (UAT-007)</name>
  <files>src/main.ts</files>
  <action>
    **Make grid automatically recover focus:**

    1. Add document-level click handler in main.ts that refocuses the grid:
       ```typescript
       document.addEventListener('click', () => {
         // Small delay to allow any other click handlers to process first
         requestAnimationFrame(() => {
           guessGrid.focusGrid();
         });
       });
       ```

    2. This ensures that whenever user clicks anywhere (New Game button, suggestions, page background), focus returns to the grid automatically.

    3. Alternative approach if needed: use focusin/focusout events to detect when grid loses focus and immediately reclaim it. But the click handler is simpler and should work.

    **Note:** The grid already handles focus for typing. This just ensures focus is always restored after any click interaction.
  </action>
  <verify>
    - Click New Game button - grid re-focuses (can type immediately)
    - Click on a word in suggestions - grid re-focuses
    - Click on empty page area - grid re-focuses
    - Never need to manually click grid to type
  </verify>
  <done>Grid automatically recovers focus after any click on page</done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration</name>
  <files>src/main.ts</files>
  <action>
    Test and verify:

    1. Prefix filtering works with constraints:
       - Enter "CRANE" with some colors → filters to matching words
       - Type "S" in row 2 → shows only matching words starting with S
       - Backspace the S → returns to constraint-only filter

    2. Focus recovery doesn't interfere with grid operation:
       - Can still type letters normally
       - Can still click cells to change colors
       - New Game still works correctly

    3. Edge cases:
       - Empty grid shows full word list
       - Single letter filters correctly
       - Deleting all letters restores full list

    4. Build passes: npm run build
  </action>
  <verify>
    - Combined filtering (constraints + prefix) works correctly
    - Focus auto-recovery doesn't break anything
    - Build succeeds
  </verify>
  <done>All edge cases handled, build succeeds</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Typing partial words filters suggestions immediately
- [ ] Grid auto-recovers focus after clicking anywhere
- [ ] Constraint filtering still works for complete rows
- [ ] Combined filtering (constraints + prefix) works
- [ ] No TypeScript errors
</verification>

<success_criteria>
- UAT-006 and UAT-007 from 04-ISSUES.md addressed
- Per-keystroke filtering implemented
- Auto-focus recovery implemented
- Tests pass, build succeeds
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-interface/04-FIX2-SUMMARY.md`
</output>
