---
phase: 18-internationalization
plan: 03
type: execute
wave: 2
depends_on: ["18-01"]
files_modified: [src/ui/Keyboard.ts, src/styles/main.css]
autonomous: false
---

<objective>
Add long-press accent support to on-screen keyboard for Portuguese characters.

Purpose: Enable typing accented characters (á, é, ç, etc.) on the on-screen keyboard.
Output: Long-press on vowels/C shows accent popup, user can select accented character.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-internationalization/DISCOVERY.md

@src/ui/Keyboard.ts
@src/styles/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accent map configuration</name>
  <files>src/ui/Keyboard.ts</files>
  <action>
1. Add accent map at the top of Keyboard.ts:
   ```typescript
   /**
    * Accent options for long-press on keyboard keys
    * Maps base letter to available accented variants
    */
   const ACCENT_MAP: Record<string, string[]> = {
     a: ['á', 'à', 'â', 'ã'],
     e: ['é', 'ê'],
     i: ['í'],
     o: ['ó', 'ô', 'õ'],
     u: ['ú'],
     c: ['ç'],
   };

   /**
    * How long to hold a key before showing accent popup (ms)
    */
   const LONG_PRESS_DELAY = 500;
   ```

2. Add property to track if accents are enabled:
   ```typescript
   private accentsEnabled: boolean = false;
   ```

3. Add method to enable/disable accents:
   ```typescript
   /**
    * Enable or disable accent support for the keyboard
    * When enabled, long-pressing vowels/C shows accent options
    */
   public setAccentsEnabled(enabled: boolean): void {
     this.accentsEnabled = enabled;
   }
   ```
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Accent map and configuration added</done>
</task>

<task type="auto">
  <name>Task 2: Add long-press detection</name>
  <files>src/ui/Keyboard.ts</files>
  <action>
1. Add properties for tracking long-press state:
   ```typescript
   private longPressTimer: number | null = null;
   private longPressKey: string | null = null;
   private accentPopup: HTMLElement | null = null;
   ```

2. Update `attachClickListeners()` to handle long-press:
   ```typescript
   private attachClickListeners(): void {
     // Handle pointer down for long-press detection
     this.containerElement.addEventListener('pointerdown', (event) => {
       const target = event.target as HTMLElement;
       const keyElement = target.closest('.key') as HTMLElement | null;

       if (!keyElement) return;

       const key = keyElement.dataset.key?.toLowerCase();
       if (!key || key === 'enter' || key === 'backspace') return;

       // Start long-press timer if accents enabled and key has accents
       if (this.accentsEnabled && ACCENT_MAP[key]) {
         this.longPressKey = key;
         this.longPressTimer = window.setTimeout(() => {
           this.showAccentPopup(keyElement, key);
         }, LONG_PRESS_DELAY);
       }
     });

     // Handle pointer up - either fire key or select accent
     this.containerElement.addEventListener('pointerup', (event) => {
       const target = event.target as HTMLElement;

       // If accent popup is showing, check if we're over an accent option
       if (this.accentPopup) {
         const accentOption = target.closest('.accent-option') as HTMLElement | null;
         if (accentOption && this.keyPressCallback) {
           const accent = accentOption.dataset.accent;
           if (accent) {
             this.keyPressCallback(accent);
           }
         }
         this.hideAccentPopup();
         this.clearLongPressTimer();
         return;
       }

       // Clear long-press timer
       this.clearLongPressTimer();

       // Normal click handling
       const keyElement = target.closest('.key') as HTMLElement | null;
       if (keyElement && this.keyPressCallback) {
         const key = keyElement.dataset.key;
         if (key) {
           this.keyPressCallback(key);
         }
       }
     });

     // Handle pointer leave (cancel long-press if user drags away)
     this.containerElement.addEventListener('pointerleave', () => {
       this.clearLongPressTimer();
       // Don't hide popup - user might be dragging to select
     });

     // Handle pointer cancel
     this.containerElement.addEventListener('pointercancel', () => {
       this.clearLongPressTimer();
       this.hideAccentPopup();
     });
   }

   private clearLongPressTimer(): void {
     if (this.longPressTimer !== null) {
       window.clearTimeout(this.longPressTimer);
       this.longPressTimer = null;
     }
     this.longPressKey = null;
   }
   ```
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Long-press detection implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add accent popup UI</name>
  <files>src/ui/Keyboard.ts</files>
  <action>
1. Add method to show accent popup:
   ```typescript
   private showAccentPopup(keyElement: HTMLElement, key: string): void {
     const accents = ACCENT_MAP[key];
     if (!accents || accents.length === 0) return;

     // Create popup element
     this.accentPopup = document.createElement('div');
     this.accentPopup.className = 'accent-popup';
     this.accentPopup.innerHTML = accents
       .map(accent => `<div class="accent-option" data-accent="${accent}">${accent.toUpperCase()}</div>`)
       .join('');

     // Position popup above the key
     const keyRect = keyElement.getBoundingClientRect();
     const containerRect = this.containerElement.getBoundingClientRect();

     // Calculate position relative to container
     const left = keyRect.left - containerRect.left + keyRect.width / 2;
     const top = keyRect.top - containerRect.top;

     this.accentPopup.style.left = `${left}px`;
     this.accentPopup.style.top = `${top}px`;

     // Add to container
     this.containerElement.appendChild(this.accentPopup);

     // Add active class after a frame for animation
     requestAnimationFrame(() => {
       this.accentPopup?.classList.add('active');
     });

     // Highlight the key
     keyElement.classList.add('key-accent-active');
   }
   ```

2. Add method to hide accent popup:
   ```typescript
   private hideAccentPopup(): void {
     if (this.accentPopup) {
       // Remove highlight from key
       const activeKey = this.containerElement.querySelector('.key-accent-active');
       activeKey?.classList.remove('key-accent-active');

       // Remove popup
       this.accentPopup.remove();
       this.accentPopup = null;
     }
   }
   ```
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Accent popup UI methods implemented</done>
</task>

<task type="auto">
  <name>Task 4: Add accent popup styles</name>
  <files>src/styles/main.css</files>
  <action>
1. Add styles for accent popup:
   ```css
   /* Accent popup for long-press */
   .accent-popup {
     position: absolute;
     display: flex;
     gap: 4px;
     padding: 8px;
     background: var(--color-tone-2);
     border-radius: 8px;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
     transform: translate(-50%, -100%) translateY(-8px);
     opacity: 0;
     pointer-events: none;
     transition: opacity 0.15s ease;
     z-index: 100;
   }

   .accent-popup.active {
     opacity: 1;
     pointer-events: auto;
   }

   .accent-option {
     min-width: 40px;
     height: 48px;
     display: flex;
     align-items: center;
     justify-content: center;
     background: var(--color-tone-4);
     border-radius: 4px;
     font-size: 1.25rem;
     font-weight: bold;
     cursor: pointer;
     transition: background 0.1s ease;
     user-select: none;
     -webkit-user-select: none;
   }

   .accent-option:hover {
     background: var(--color-tone-3);
   }

   .accent-option:active {
     background: var(--color-present);
   }

   /* Highlight key when accent popup is showing */
   .key-accent-active {
     background: var(--color-present) !important;
     color: white !important;
   }
   ```

2. Add touch-action to keyboard to prevent scrolling during long-press:
   ```css
   .keyboard {
     touch-action: manipulation;
   }

   .key {
     touch-action: manipulation;
     -webkit-touch-callout: none;
     -webkit-user-select: none;
     user-select: none;
   }
   ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Accent popup styled</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Long-press accent keyboard support</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Note: Accents won't work yet since they need to be enabled by the language setting (18-04)
    3. For testing, temporarily add in browser console:
       - Find the keyboard instance and call: keyboard.setAccentsEnabled(true)
       - Or add a temporary line in main.ts after keyboard init
    4. Once enabled, test:
       - Long-press (hold for 500ms) on 'A' key
       - Verify: Accent popup appears with á, à, â, ã
       - Tap one of the accents
       - Verify: The accented character is entered into the grid
       - Test on 'E', 'I', 'O', 'U', 'C' keys
       - Verify: Each shows their respective accent options
    5. Test on mobile/touch:
       - Long-press should work with touch
       - Can drag finger to select accent
    6. Verify popup positioning looks correct
    7. Verify popup closes when clicking elsewhere
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Long-press detection works (500ms delay)
- [ ] Accent popup appears above key
- [ ] All accent options display correctly
- [ ] Selecting accent fires callback with accented character
- [ ] Popup closes after selection
- [ ] Works on both mouse and touch devices
- [ ] Keyboard styling preserved, no visual glitches
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified accent keyboard works
- Ready for UI integration in 18-04
</success_criteria>

<output>
After completion, create `.planning/phases/18-internationalization/18-03-SUMMARY.md`
</output>
