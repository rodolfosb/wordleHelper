---
phase: 18-internationalization
plan: 04
type: execute
wave: 3
depends_on: ["18-01", "18-02", "18-03"]
files_modified: [src/types/index.ts, src/utils/settings.ts, src/ui/SettingsModal.ts, src/main.ts, src/logic/filter.ts]
autonomous: false
---

<objective>
Add language selector to Settings and integrate Portuguese support into Open Mode gameplay.

Purpose: Enable users to select and play with Portuguese words in Open Mode.
Output: Working language selector, Open Mode uses selected language, keyboard accents enabled for Portuguese.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-internationalization/DISCOVERY.md
@.planning/phases/18-internationalization/18-01-SUMMARY.md
@.planning/phases/18-internationalization/18-02-SUMMARY.md
@.planning/phases/18-internationalization/18-03-SUMMARY.md

@src/types/index.ts
@src/utils/settings.ts
@src/ui/SettingsModal.ts
@src/ui/Keyboard.ts
@src/main.ts
@src/logic/filter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wordLanguage to AppSettings</name>
  <files>src/types/index.ts, src/utils/settings.ts</files>
  <action>
1. In `src/types/index.ts`, add to AppSettings interface:
   ```typescript
   /** Language for word lists in Open Mode */
   wordLanguage: 'en' | 'pt';
   ```

2. In `src/utils/settings.ts`:
   - Add `wordLanguage: 'en'` to DEFAULT_SETTINGS
   - The setting will persist with other app settings automatically
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>wordLanguage setting added to AppSettings with default 'en'</done>
</task>

<task type="auto">
  <name>Task 2: Add language selector to SettingsModal</name>
  <files>src/ui/SettingsModal.ts</files>
  <action>
1. Add language selector HTML in createModal(), after NYT Mode toggle:
   ```html
   <div class="settings-item">
     <div class="settings-label">
       <span class="settings-name">Word Language</span>
       <span class="settings-description" id="word-language-description">Language for Open Mode words</span>
     </div>
     <select id="setting-word-language" class="settings-select">
       <option value="en">English</option>
       <option value="pt">Português</option>
     </select>
   </div>
   ```

2. Update setupToggleHandlers() to handle language selection:
   ```typescript
   const wordLanguageSelect = this.modalElement.querySelector('#setting-word-language') as HTMLSelectElement;

   wordLanguageSelect?.addEventListener('change', () => {
     this.currentSettings.wordLanguage = wordLanguageSelect.value as 'en' | 'pt';
     this.updateWordLengthSelectorState();
     this.notifySettingsChange();
   });
   ```

3. Update updateWordLengthSelectorState() to handle language selector state:
   ```typescript
   private updateWordLengthSelectorState(): void {
     if (!this.modalElement) return;

     const wordLengthSelect = this.modalElement.querySelector('#setting-word-length') as HTMLSelectElement;
     const wordLengthDescription = this.modalElement.querySelector('#word-length-description') as HTMLSpanElement;
     const wordLanguageSelect = this.modalElement.querySelector('#setting-word-language') as HTMLSelectElement;
     const wordLanguageDescription = this.modalElement.querySelector('#word-language-description') as HTMLSpanElement;

     // Word length: enabled unless NYT Mode is on
     if (wordLengthSelect) {
       wordLengthSelect.disabled = this.currentSettings.nytMode;
     }

     if (wordLengthDescription) {
       if (this.currentSettings.nytMode) {
         wordLengthDescription.textContent = 'NYT Mode uses 5 letters';
       } else {
         wordLengthDescription.textContent = 'Number of letters for Open Mode games';
       }
     }

     // Word language: disabled if NYT Mode (always English)
     if (wordLanguageSelect) {
       wordLanguageSelect.disabled = this.currentSettings.nytMode;
     }

     if (wordLanguageDescription) {
       if (this.currentSettings.nytMode) {
         wordLanguageDescription.textContent = 'NYT Mode uses English words';
       } else {
         wordLanguageDescription.textContent = 'Language for Open Mode words';
       }
     }
   }
   ```

4. Update render() to set word language selector value:
   ```typescript
   const wordLanguageSelect = this.modalElement.querySelector('#setting-word-language') as HTMLSelectElement;
   if (wordLanguageSelect) {
     wordLanguageSelect.value = settings.wordLanguage;
   }
   ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Language selector in Settings with proper disable logic</done>
</task>

<task type="auto">
  <name>Task 3: Update word validation for language</name>
  <files>src/logic/filter.ts</files>
  <action>
1. Import language helpers:
   ```typescript
   import { getWordSetForLanguageAndLength, type WordLanguage } from '../data/words';
   ```

2. Update isValidWord() to accept language parameter:
   ```typescript
   /**
    * Check if a word is valid (exists in word list for given length and language)
    * @param word - The word to validate
    * @param length - The word length to check against (defaults to 5)
    * @param language - The word language to check against (defaults to 'en')
    * @returns True if word is valid
    */
   export function isValidWord(word: string, length: number = 5, language: WordLanguage = 'en'): boolean {
     const wordSet = getWordSetForLanguageAndLength(language, length);
     return wordSet.has(word.toLowerCase());
   }
   ```
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Word validation supports language parameter</done>
</task>

<task type="auto">
  <name>Task 4: Integrate language setting into Open Mode</name>
  <files>src/main.ts</files>
  <action>
1. Import new helpers:
   ```typescript
   import { WORD_LIST, getWordListForLength, getWordListForLanguageAndLength, getWordSetForLanguageAndLength } from './data/words';
   ```

2. Track previous language setting:
   ```typescript
   let previousWordLanguage: 'en' | 'pt' = 'en';
   ```

3. Update applySettings() to handle language changes:
   ```typescript
   // Apply word language change in Open Mode (but not on initial load)
   if (!isInitial && !settings.nytMode && settings.wordLanguage !== previousWordLanguage) {
     // Exit practice mode if active
     if (practiceMode) {
       practiceMode = false;
       practiceIndicator.classList.add('hidden');
     }
     // Reset and reinitialize with new language
     resetGame();
   }
   previousWordLanguage = settings.wordLanguage;

   // Enable/disable keyboard accents based on language
   keyboard.setAccentsEnabled(settings.wordLanguage === 'pt');
   ```

4. Update initializeGame() to use language-aware word list:
   ```typescript
   // Open mode: select random word based on word length and language settings
   const wordList = getWordListForLanguageAndLength(appSettings.wordLanguage, currentWordLength);
   openModeTarget = selectRandomWord(wordList);
   ```

5. Update updatePuzzleInfo() to show language:
   ```typescript
   if (!puzzle && !isNYTMode) {
     // Open Mode: show word length and language
     const langLabel = appSettings.wordLanguage === 'pt' ? 'Português' : 'English';
     puzzleInfo.textContent = `Open Mode (${wordLength} letters) - ${langLabel}`;
     puzzleInfo.classList.remove('stale-data-warning');
     return;
   }
   ```

6. Update resetGame() to use language setting:
   ```typescript
   // Reset suggestions to show full word list ranked for current word length and language
   const wordList = getWordListForLanguageAndLength(appSettings.wordLanguage, currentWordLength);
   filteredWords = wordList;
   const rankedWords = rankWords(wordList, wordList);
   suggestions.update(rankedWords, wordList.length);
   ```

7. Update updateSuggestions() to use language setting:
   ```typescript
   // Get the appropriate word list for current word length and language
   const wordList = getWordListForLanguageAndLength(appSettings.wordLanguage, currentWordLength);
   ```

8. Update word validation call in guessGrid.onSubmit() callback:
   ```typescript
   // Check if word is valid using the current word length and language
   if (!isValidWord(word, currentWordLength, appSettings.wordLanguage)) {
     guessGrid.shakeRow(row);
     showGameMessage('Not in word list', 'error');
     return;
   }
   ```

9. Initialize previousWordLanguage from settings after loading:
   ```typescript
   previousWordLanguage = appSettings.wordLanguage;
   ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Open Mode uses language setting for word selection, validation, and display</done>
</task>

<task type="auto">
  <name>Task 5: Handle accented character input from physical keyboard</name>
  <files>src/main.ts or src/ui/GuessGrid.ts</files>
  <action>
1. Ensure the physical keyboard input handler accepts accented characters when Portuguese is selected.

2. In the keydown handler, update the valid character check:
   ```typescript
   // Check if character is valid for current language
   const isValidChar = appSettings.wordLanguage === 'pt'
     ? /^[a-záàâãéêíóôõúç]$/i.test(key)
     : /^[a-z]$/i.test(key);

   if (isValidChar) {
     // Handle letter input
   }
   ```

3. Ensure the character is converted to lowercase before processing.
  </action>
  <verify>npm run build succeeds</verify>
  <done>Physical keyboard accepts accented characters for Portuguese</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full Portuguese language support in Open Mode</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Open Settings (gear icon)
    3. Turn OFF "NYT Mode" to enable Open Mode
    4. Verify: "Word Language" dropdown is visible and enabled
    5. Select "Português" from Word Language dropdown
    6. Verify: Word Language shows "Português" selected
    7. Close Settings
    8. Verify: Puzzle info shows "Open Mode (5 letters) - Português"
    9. Test on-screen keyboard:
       - Long-press 'A' key (hold 500ms)
       - Verify: Accent popup appears with á, à, â, ã
       - Tap 'á' accent
       - Verify: á appears in the grid
    10. Test physical keyboard:
        - Type 'á' directly (if your keyboard supports it)
        - Verify: á appears in the grid
    11. Try a Portuguese word like "AÇÚCAR" (if 6 letters) or "TERMO" (5 letters)
        - Verify: Word is accepted
    12. Try an English-only word like "CRANE"
        - Verify: Word is rejected ("Not in word list")
    13. Change word length to 6 letters
        - Play a game with a 6-letter Portuguese word
    14. Switch back to English in Settings
        - Verify: "CRANE" is now accepted
        - Verify: Long-press accents no longer show (or are disabled)
    15. Verify: Language setting persists after page refresh
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Language selector appears in Settings when NYT Mode is off
- [ ] Language selector disabled when NYT Mode is on
- [ ] Open Mode displays language in puzzle info
- [ ] Portuguese words accepted when Portuguese selected
- [ ] English-only words rejected when Portuguese selected
- [ ] Long-press accents work when Portuguese selected
- [ ] Physical keyboard accepts accented chars for Portuguese
- [ ] Language setting persists after page refresh
- [ ] Switching language resets the game properly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified Portuguese gameplay works correctly
- Full internationalization feature complete
</success_criteria>

<output>
After completion, create `.planning/phases/18-internationalization/18-04-SUMMARY.md`
</output>
